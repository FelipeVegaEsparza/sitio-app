---
// This page recreates the NowPlayingBanner as a standalone player page for the 'modern' template.
import Layout from '../layouts/Layout.astro';
import { getIpstreamData, getFullImageUrl, CONFIG } from '../../../utils/api';

// 1. Fetch the data needed for the player and header elements
const basicData = await getIpstreamData('/basic-data');
const radioStreamingUrl = basicData?.radioStreamingUrl || '';
const sonicApiUrl = CONFIG.SONIC_API_URL;

const socialNetworks = await getIpstreamData('/social-networks');
const siteLogoHeader = basicData?.logoUrl ? getFullImageUrl(basicData.logoUrl) : '/image/logo.png';

// 2. Logic to filter and prepare social media links
const iconMap: Record<string, string> = {
  'facebook': 'fa-facebook-f', 'instagram': 'fa-instagram', 'twitter': 'fa-twitter',
  'x': 'fa-x-twitter', 'youtube': 'fa-youtube', 'tiktok': 'fa-tiktok',
  'whatsapp': 'fa-whatsapp', 'telegram': 'fa-telegram', 'linkedin': 'fa-linkedin',
  'spotify': 'fa-spotify', 'soundcloud': 'fa-soundcloud',
};

function getIconClass(network: string): string {
  return iconMap[network.toLowerCase()] || `fa-${network.toLowerCase()}`;
}

const socialLinks = socialNetworks ? Object.entries(socialNetworks)
    .filter(([network, url]) => {
        if (network === 'createdAt' || network === 'updatedAt') return false;
        return network && url && typeof url === 'string' && url.trim() !== '';
    })
    .map(([network, url]) => {
        const link = network === 'whatsapp' ? `https://wa.me/${(url as string).replace(/\+/g, '')}` : url as string;
        const iconClass = getIconClass(network);
        const fullIconClass = `fa-brands ${iconClass}`;
        return { network, link, fullIconClass };
    }) : [];
---

<Layout title="Reproductor de Streaming">
    <header class="player-header">
        <div class="player-logo">
            <a href="/">
                <img src={siteLogoHeader} alt="Logo">
            </a>
        </div>
        {socialLinks.length > 0 && (
            <div class="player-socials">
                {socialLinks.map(({ network, link, fullIconClass }) => (
                    <a href={link} target="_blank" rel="noopener noreferrer" class="player-social-item" title={network} aria-label={network}>
                        <i class={fullIconClass}></i>
                    </a>
                ))}
            </div>
        )}
    </header>

    <section id="now-playing-banner" class="full-width-banner" style="height: 100vh;">
        <div class="image-overlay"></div>
        <canvas id="audio-visualizer" class="audio-visualizer-canvas"></canvas>
        <div class="container-fluid h-100 position-relative" style="z-index: 3; max-width: 1440px; margin: 0 auto; padding: 2rem;">
            <div class="row w-100 h-100 align-items-center g-4 hero-content-wrapper">
                <div class="col-12 col-lg-6 hero-cover-column order-lg-2">
                    <div class="d-flex flex-column align-items-center justify-content-center hero-cover-wrapper">
                        <div id="now-playing-cover" class="album-cover-container" style="display: none;">
                            <img id="now-playing-cover-img" src="" alt="Album Cover" class="album-cover-img">
                            <div class="cover-overlay">
                                <button class="cover-action-btn" title="Ver en grande">
                                    <i class="fa-solid fa-expand"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-12 col-lg-6 hero-info-column order-lg-1">
                    <div class="d-flex flex-column gap-4 hero-info-wrapper">
                        <div class="now-playing-info">
                            <div class="scrolling-text-container" style="background-color: transparent !important;">
                                <div class="scrolling-text-wrapper">
                                    <div class="scrolling-text" id="scrolling-text-display">
                                        <span id="now-playing-artist" class="artist-text">Cargando...</span>
                                        <span class="separator"> - </span>
                                        <span id="now-playing-title" class="title-text">Cargando...</span>
                                    </div>
                                </div>
                            </div>
                            <div class="d-flex justify-content-center gap-4 mt-2">
                                <span id="now-playing-listeners" class="stats-item">
                                    <i class="fa-solid fa-headphones"></i> <span class="stats-value">0</span> Oyentes
                                </span>
                                <button id="like-song-btn" class="stats-item like-btn">
                                    <i class="fa-regular fa-heart"></i> <span id="likes-count" class="stats-value">0</span>
                                </button>
                            </div>
                        </div>
                        <div class="player-controls-main">
                            <audio id="audio-player" crossorigin="anonymous">
                                Tu navegador no soporta el elemento de audio.
                            </audio>
                            <div class="d-flex flex-row gap-3 align-items-center justify-content-center">
                                <button id="play-live-button" type="button" class="btn request-loader">
                                    <i class="fa-solid fa-play"></i>
                                </button>
                                <a href="#" class="btn button font-1 ls-2 d-flex align-items-center">
                                    <i class="fa-brands fa-app-store-ios me-2"></i> INSTALA APP
                                </a>
                            </div>
                        </div>
                        <div class="share-buttons-container glass-effect-box">
                            <span class="share-label">Compartir:</span>
                            <div class="share-buttons">
                                <button class="share-btn share-fb" title="Compartir en Facebook" data-platform="facebook">
                                    <i class="fa-brands fa-facebook-f"></i>
                                </button>
                                <button class="share-btn share-tw" title="Compartir en Twitter" data-platform="twitter">
                                    <i class="fa-brands fa-twitter"></i>
                                </button>
                                <button class="share-btn share-wa" title="Compartir en WhatsApp" data-platform="whatsapp">
                                    <i class="fa-brands fa-whatsapp"></i>
                                </button>
                                <button class="share-btn share-tg" title="Compartir en Telegram" data-platform="telegram">
                                    <i class="fa-brands fa-telegram"></i>
                                </button>
                                <button class="share-btn share-copy" title="Copiar enlace" data-platform="copy">
                                    <i class="fa-solid fa-link"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <script define:vars={{ radioStreamingUrl, sonicApiUrl }}>
        window.globalRadioStreamingUrl = radioStreamingUrl;
        window.globalSonicApiUrl = sonicApiUrl;
    </script>

    <script is:inline>
        const SONIC_API_URL = window.globalSonicApiUrl;
        const radioStreamingUrl = window.globalRadioStreamingUrl;
        let audioContext = null;
        let analyser = null;
        let currentSongData = null;
        let likesCount = 0;

        async function getCurrentSongDataClient() {
            try {
                const response = await fetch(`${SONIC_API_URL}&rand=${Date.now()}`);
                if (!response.ok) {
                    console.error(`Error HTTP: ${response.status}`);
                    return null;
                }
                return await response.json();
            } catch (error) {
                console.error('Error al obtener datos:', error);
                return null;
            }
        }

        function updateNowPlayingBanner(data) {
            const banner = document.getElementById('now-playing-banner');
            const coverContainer = document.getElementById('now-playing-cover');
            const coverImg = document.getElementById('now-playing-cover-img');

            if (banner && data && data.art) {
                const imageUrlWithBuster = `${data.art}?timestamp=${new Date().getTime()}`;
                const preloadImage = new Image();
                preloadImage.onload = () => {
                    banner.style.setProperty('--bg-image', `url(${imageUrlWithBuster})`);
                    banner.classList.add('blurred-background');
                    if (coverImg && coverContainer) {
                        coverImg.src = imageUrlWithBuster;
                        coverContainer.style.display = 'block';
                    }
                };
                preloadImage.src = imageUrlWithBuster;
            }
        }

        function updateNowPlayingInfo(data) {
            const titleEl = document.getElementById('now-playing-title');
            const artistEl = document.getElementById('now-playing-artist');
            const listenersEl = document.querySelector('#now-playing-listeners .stats-value');
            const scrollingTextWrapper = document.querySelector('.scrolling-text-wrapper');
            const scrollingTextDisplay = document.getElementById('scrolling-text-display');

            if (data && data.title) {
                const parts = data.title.split(' - ');
                let artist = '';
                let title = '';
                if (parts.length === 2) {
                    artist = parts[0];
                    title = parts[1];
                } else {
                    title = data.title;
                }
                if (artistEl) artistEl.textContent = artist;
                if (titleEl) titleEl.textContent = title;
                if (scrollingTextWrapper && scrollingTextDisplay) {
                    scrollingTextWrapper.classList.remove('scroll-active');
                    const fullText = artist ? `${artist} - ${title}` : title;
                    scrollingTextDisplay.setAttribute('data-text', fullText);
                    void scrollingTextDisplay.offsetWidth;
                    setTimeout(() => {
                        const container = document.querySelector('.scrolling-text-container');
                        const textWidth = scrollingTextDisplay.offsetWidth;
                        const containerWidth = container.offsetWidth;
                        if (textWidth > containerWidth - 60) {
                            scrollingTextWrapper.classList.add('scroll-active');
                        } else {
                            scrollingTextWrapper.classList.remove('scroll-active');
                        }
                    }, 150);
                }
            }
            if (listenersEl && data && data.listeners) {
                listenersEl.textContent = data.listeners;
            }
            currentSongData = data;
        }

        function setupAudioPlayer(streamUrl) {
            const audioPlayer = document.getElementById('audio-player');
            const playLiveButton = document.getElementById('play-live-button');
            if (!audioPlayer || !playLiveButton) return;
            const playIcon = playLiveButton.querySelector('i');
            if (!playIcon) return;
            if (!streamUrl || streamUrl === '') {
                console.error('URL del stream no proporcionada');
                return;
            }
            audioPlayer.src = streamUrl;
            audioPlayer.volume = 0.8;
            audioPlayer.load();
            playLiveButton.addEventListener('click', function() {
                if (audioPlayer.paused) {
                    audioPlayer.play()
                        .then(() => {
                            playIcon.className = 'fa-solid fa-pause';
                            setupVisualizer();
                        })
                        .catch(error => {
                            console.error('Error al reproducir:', error);
                            playIcon.className = 'fa-solid fa-play';
                        });
                } else {
                    audioPlayer.pause();
                    playIcon.className = 'fa-solid fa-play';
                }
            });
            audioPlayer.addEventListener('playing', () => { playIcon.className = 'fa-solid fa-pause'; });
            audioPlayer.addEventListener('pause', () => { playIcon.className = 'fa-solid fa-play'; });
        }

        function setupShareButtons() {
            const shareButtons = document.querySelectorAll('.share-btn');
            shareButtons.forEach(btn => {
                btn.addEventListener('click', () => {
                    const platform = btn.dataset.platform;
                    const songInfo = currentSongData ? currentSongData.title : 'esta radio';
                    const url = window.location.href;
                    const text = `Estoy escuchando ${songInfo} en vivo!`;
                    let shareUrl = '';
                    switch(platform) {
                        case 'facebook': shareUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(url)}`; break;
                        case 'twitter': shareUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(text)}&url=${encodeURIComponent(url)}`; break;
                        case 'whatsapp': shareUrl = `https://wa.me/?text=${encodeURIComponent(text + ' ' + url)}`; break;
                        case 'telegram': shareUrl = `https://t.me/share/url?url=${encodeURIComponent(url)}&text=${encodeURIComponent(text)}`; break;
                        case 'copy':
                            navigator.clipboard.writeText(url).then(() => {
                                btn.innerHTML = '<i class="fa-solid fa-check"></i>';
                                setTimeout(() => { btn.innerHTML = '<i class="fa-solid fa-link"></i>'; }, 2000);
                            });
                            return;
                    }
                    if (shareUrl) window.open(shareUrl, '_blank', 'width=600,height=400');
                });
            });
        }

        function setupLikeButton() {
            const likeBtn = document.getElementById('like-song-btn');
            const likesCountEl = document.getElementById('likes-count');
            const likeIcon = likeBtn?.querySelector('i');
            likeBtn?.addEventListener('click', () => {
                likesCount++;
                likesCountEl.textContent = likesCount;
                if (likeIcon) {
                    likeIcon.className = 'fa-solid fa-heart';
                    setTimeout(() => { likeIcon.className = 'fa-regular fa-heart'; }, 1000);
                }
                likeBtn.style.transform = 'scale(1.2)';
                setTimeout(() => { likeBtn.style.transform = 'scale(1)'; }, 200);
            });
        }

        function setupVisualizer() {
            if (audioContext) return;
            const audioPlayer = document.getElementById('audio-player');
            const canvas = document.getElementById('audio-visualizer');
            if (!canvas || !audioPlayer) return;
            const ctx = canvas.getContext('2d');
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            analyser = audioContext.createAnalyser();
            const source = audioContext.createMediaElementSource(audioPlayer);
            source.connect(analyser);
            analyser.connect(audioContext.destination);
            analyser.fftSize = 256;
            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            function draw() {
                requestAnimationFrame(draw);
                analyser.getByteFrequencyData(dataArray);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.05)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                const barWidth = (canvas.width / bufferLength) * 2.5;
                let barHeight;
                let x = 0;
                for (let i = 0; i < bufferLength; i++) {
                    barHeight = (dataArray[i] / 255) * canvas.height * 0.5;
                    const gradient = ctx.createLinearGradient(0, canvas.height, 0, canvas.height - barHeight);
                    gradient.addColorStop(0, 'rgba(0, 74, 173, 0.8)');
                    gradient.addColorStop(1, 'rgba(0, 150, 255, 0.9)');
                    ctx.fillStyle = gradient;
                    ctx.fillRect(x, canvas.height - barHeight, barWidth, barHeight);
                    x += barWidth + 1;
                }
            }
            draw();
        }

        function startNowPlayingUpdates(callback, interval = 10000) {
            getCurrentSongDataClient().then(data => { if (data) callback(data); });
            setInterval(async () => {
                const data = await getCurrentSongDataClient();
                if (data) callback(data);
            }, interval);
        }

        document.addEventListener('DOMContentLoaded', () => {
            startNowPlayingUpdates(data => {
                updateNowPlayingBanner(data);
                updateNowPlayingInfo(data);
            });
            setupAudioPlayer(radioStreamingUrl);
            setupShareButtons();
            setupLikeButton();
        });
    </script>

    <style>
        /* Responsive layout for the player on small screens */
        @media (max-width: 991px) {
            #now-playing-banner {
                height: auto;
                min-height: 100vh;
                padding-bottom: 4rem; /* Add some space at the bottom */
            }
            .hero-content-wrapper.row {
                display: flex !important;
                flex-direction: column !important;
                flex-wrap: nowrap !important;
                align-items: center !important;
                justify-content: flex-start !important;
                height: auto !important;
                padding-top: 4rem; /* Reduced padding to move content higher */
            }
            .hero-cover-column { order: 1 !important; width: 100% !important; max-width: 100% !important; flex: 0 0 auto !important; margin-bottom: 0 !important; padding-left: 0 !important; padding-right: 0 !important; } /* Removed margin-bottom */
            #now-playing-cover { aspect-ratio: 1; } /* Make cover container square */
            #now-playing-cover { aspect-ratio: 1; width: 100%; margin: 0 auto 2rem auto; display: block !important; } /* Make cover container square and fill width */
            .hero-info-column { order: 2 !important; width: 100% !important; max-width: 100% !important; flex: 0 0 auto !important; padding-left: 0 !important; padding-right: 0 !important; }
            .hero-cover-wrapper, .hero-info-wrapper { width: 100% !important; height: auto !important; min-height: auto !important; justify-content: center !important; }
            /* Removed max-width from #now-playing-cover[style*="display: block"] rule */
            .album-cover-img { width: 100%; height: auto; aspect-ratio: 1; object-fit: cover; border-radius: 15px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5); }
            .hero-info-wrapper { text-align: center; }

            /* Hide listeners and likes section on small screens */
            .now-playing-info > .d-flex.justify-content-center {
                display: none !important;
            }
        }

        /* Styles for the new header elements */
        .player-header {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            padding: 1.5rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            z-index: 10;
        }
        .player-logo img {
            height: 50px;
            width: auto;
            max-width: 200px;
        }
        .player-socials {
            display: flex;
            gap: 0.75rem;
        }
        .player-social-item {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.8);
            transition: all 0.3s ease;
            text-decoration: none;
        }
        .player-social-item:hover {
            background-color: var(--accent-color);
            color: white;
            transform: translateY(-2px);
        }
        .player-social-item i {
            font-size: 0.9rem;
        }
    </style>
</Layout>
