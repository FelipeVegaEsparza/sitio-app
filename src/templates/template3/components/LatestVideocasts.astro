---
import VideocastCard from './VideocastCard.astro';

interface Videocast {
    title: string;
    description: string;
    imageUrl: string;
    videoUrl: string;
}

interface Props {
    videocasts: Videocast[];
}

const { videocasts } = Astro.props;

// Defensive check for the videocasts data structure
const videocastsArray = Array.isArray(videocasts) ? videocasts : (videocasts && Array.isArray(videocasts.data)) ? videocasts.data : [];

const latestVideocasts = videocastsArray.slice(0, 3);
---

<section id="videocasts" class="latest-videocasts-section">
    <div class="container">
        <div class="section-title-wrapper">
            <div class="title-left">
                <i class="section-icon fas fa-video"></i>
                <h2 class="section-title">Videocasts</h2>
            </div>
            <p class="section-description">Nuestros Ãºltimos programas en video.</p>
        </div>
        <div class="videocasts-grid">
            {latestVideocasts.map(item => (
                <VideocastCard videocast={item} />
            ))}
        </div>
    </div>
</section>

<!-- Modal Structure -->
<div id="videocast-modal" class="modal-overlay" style="display: none;">
    <div class="modal-content">
        <button id="modal-close-btn" class="modal-close-btn">&times;</button>
        <div class="modal-video-container">
            <iframe id="modal-video-iframe" width="560" height="315" src="" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
        </div>
        <h2 id="modal-title" class="modal-title"></h2>
        <p id="modal-description" class="modal-description"></p>
    </div>
</div>

<script>
    document.addEventListener('astro:page-load', () => {
        const section = document.querySelector('.latest-videocasts-section');
        if (!section) return;

        const modal = document.getElementById('videocast-modal');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const modalTitle = document.getElementById('modal-title');
        const modalDescription = document.getElementById('modal-description');
        const modalIframe = document.getElementById('modal-video-iframe');

        function openModal(title, description, videoUrl) {
            if (!modal || !modalTitle || !modalDescription || !modalIframe) return;
            
            // Convert regular YouTube URL to embeddable URL
            const embedUrl = videoUrl.replace("watch?v=", "embed/");
            
            modalTitle.textContent = title;
            modalDescription.textContent = description;
            modalIframe.src = embedUrl;
            modal.style.display = 'flex';
        }

        function closeModal() {
            if (!modal || !modalIframe) return;
            modal.style.display = 'none';
            modalIframe.src = ''; // Stop the video
        }

        section.addEventListener('click', (e) => {
            const playButton = (e.target as HTMLElement).closest('.play-button');
            if (playButton) {
                const { title, description, videoUrl } = (playButton as HTMLElement).dataset;
                openModal(title, description, videoUrl);
            }
        });

        modalCloseBtn.addEventListener('click', closeModal);
        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                closeModal();
            }
        });
    });
</script>

<style>
    .latest-videocasts-section {
        padding: 2rem 2rem; /* Reduced vertical padding */
        background-color: #fff;
    }
    .container {
        max-width: 1200px;
        margin: 0 auto;
    }
    .section-title-wrapper {
        display: flex;
        flex-direction: row;
        align-items: center;
        justify-content: space-between; /* Pushes title and description apart */
        margin-bottom: 2.5rem;
        animation: fadeInDown 0.8s ease-out;
        border-bottom: 1px solid #eee;
        padding-bottom: 1.5rem;
    }
    .title-left {
        display: flex;
        align-items: center;
    }
    .section-icon {
        font-size: 1.8rem; /* Slightly smaller icon */
        color: #0d6efd;
        margin-right: 1rem; /* Space between icon and title */
    }
    .section-title {
        font-size: 2.2rem; /* Slightly smaller title */
        font-weight: 700;
        text-align: left;
        margin: 0;
        color: #212529;
    }
    .section-description {
        font-size: 1rem;
        color: #6c757d;
        margin: 0;
    }

    @keyframes fadeInDown {
        from {
            opacity: 0;
            transform: translateY(-20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    .videocasts-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 1.5rem;
    }

    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0,0,0,0.7);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }
    .modal-content {
        background: #fff;
        padding: 2rem;
        border-radius: 12px;
        max-width: 900px;
        width: 90%;
        position: relative;
        box-shadow: 0 5px 15px rgba(0,0,0,0.3);
    }
    .modal-close-btn {
        position: absolute;
        top: 1rem;
        right: 1rem;
        background: none;
        border: none;
        font-size: 2rem;
        color: #6c757d;
        cursor: pointer;
    }
    .modal-video-container {
        position: relative;
        padding-bottom: 56.25%; /* 16:9 aspect ratio */
        height: 0;
        overflow: hidden;
        margin-bottom: 1rem;
    }
    .modal-video-container iframe {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
    }
    .modal-title {
        color: #212529;
        margin-bottom: 0.5rem;
    }
    .modal-description {
        color: #495057;
    }

    @media (max-width: 992px) {
        .videocasts-grid {
            grid-template-columns: 1fr;
        }
    }
</style>
