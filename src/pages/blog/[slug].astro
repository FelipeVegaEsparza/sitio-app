---
import Layout from '~/templates/default/layouts/Layout.astro';
import { getIpstreamData, getFullImageUrl } from '~/utils/api';

// En modo SSR, obtenemos el slug de los parámetros de la URL en cada petición.
const { slug } = Astro.params;

// Hacemos una llamada a la API para obtener solo la noticia con ese slug.
// La API para un solo item parece devolver el objeto directamente.
const news = await getIpstreamData(`/news/${slug}`);

// El resto de la lógica es similar, pero ahora se ejecuta en cada petición.

// Cargamos otras noticias para la barra lateral.
const otherNewsResponse = await getIpstreamData('/news?limit=4');
const otherNews = otherNewsResponse?.data?.filter(item => item && item.slug && (!news || item.slug !== news.slug)).slice(0, 4) || [];

// Cargamos datos básicos para el layout
const basicData = await getIpstreamData('/basic-data');
const layoutProps = {
  title: news?.name || 'Noticia no encontrada',
  siteLogoHeader: basicData?.logoUrl ? getFullImageUrl(basicData.logoUrl) : '/image/logo.png',
  siteLogoFooter: basicData?.logoUrl ? getFullImageUrl(basicData.logoUrl) : '/image/logo.png',
  footerDescription: basicData?.projectDescription || '',
  socialNetworks: await getIpstreamData('/social-networks'),
};
---

<Layout {...layoutProps}>
  {news ? (
    <!-- SI LA NOTICIA EXISTE, MOSTRAMOS EL CONTENIDO COMPLETO -->
    <main>
      <section class="section position-relative bg-cover" style={`background-image: url(${getFullImageUrl(news.imageUrl)});`}>
          <div class="image-overlay"></div>
          <div class="r-container  position-relative" style="z-index: 2;">
              <div class="d-flex flex-column">
                  <h2 class="font-1 fw-bold">Noticia <span class="accent-color">Completa</span></h2>
                  <nav aria-label="breadcrumb">
                      <ol class="breadcrumb font-2">
                          <li class="breadcrumb-item"><a href="/">Home</a></li>
                          <li class="breadcrumb-item active" aria-current="page">Noticia</li>
                      </ol>
                  </nav>
              </div>
          </div>
      </section>

      <section class="section">
          <div class="r-container">
              <div class="d-flex flex-lg-row flex-column-reverse gap-3">
                  <div class="col col-lg-4 pe-lg-4">
                      <div class="d-flex flex-column gap-3">

                          <div class="bg-secondary-color d-flex flex-column gap-3 rounded-3 px-5 py-4">
                              <h5 class="accent-color border-bottom border-accent-color pb-2 font-1 fw-bold">Otras Noticias</h5>
                              <div class="d-flex flex-column gap-3" id="other-news-container">
                                  {
                                      otherNews.map(otherNewsItem => (
                                          <div class="row row-cols-2">
                                              <div class="col-5">
                                                  <img src={getFullImageUrl(otherNewsItem.imageUrl)} alt={otherNewsItem.name}
                                                      class="img-fluid rounded-3">
                                              </div>
                                              <div class="col-7 p-0 d-flex flex-column justify-content-center">
                                                  <a href={`/blog/${otherNewsItem.slug}`} class="link-white font-1">{otherNewsItem.name}</a>
                                                  <span class="accent-color">{new Date(otherNewsItem.createdAt).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
                                              </div>
                                          </div>
                                      ))
                                  }
                              </div>
                          </div>
                          
                          <div class="bg-secondary-color d-flex flex-column gap-3 rounded-3 px-5 py-4">
                              <h5 class="accent-color border-bottom border-accent-color pb-2 font-1 fw-bold">
                                  siguenos en las redes</h5>
                              <div class="social-container mb-lg-0 mb-3" id="social-links-single-post">
                                  {
                                      layoutProps.socialNetworks && Object.entries(layoutProps.socialNetworks)
                                      .filter(([network, url]) => {
                                          // Excluir campos de metadatos que no son redes sociales
                                          if (network === 'createdAt' || network === 'updatedAt') {
                                              return false;
                                          }
                                          // Asegurarse de que la red y la URL sean válidas
                                          return network && url && typeof url === 'string' && url.trim() !== '';
                                      })
                                      .map(([network, url]) => {
                                          // Para WhatsApp, construir un enlace wa.me para mayor compatibilidad
                                          const link = network === 'whatsapp' ? `https://wa.me/${(url as string).replace(/\+/g, '')}` : url as string;
                                          return (
                                            <a href={link} class="social-item" target="_blank">
                                                <i class={`fa-brands fa-${network}`}></i>
                                            </a>
                                          )
                                      })
                                  }
                              </div>
                          </div>
                      </div>
                  </div>
                  <div class="col col-lg-8" id="post-detail-container">
                      <div class="d-flex flex-column gap-3">
                          <h2 class="font-1 fw-bold lh-1">{news.name}</h2>
                          <div class="d-flex flex-row gap-5">
                              <div class="d-flex flex-row align-items-center gap-2">
                                  <i class="fa-solid fa-user accent-color"></i>
                                  <span>Goodsound</span>
                              </div>
                              <div class="d-flex flex-row align-items-center gap-2">
                                  <i class="fa-solid fa-calendar accent-color"></i>
                                  <span>{new Date(news.createdAt).toLocaleDateString('es-ES', { day: 'numeric', month: 'long', year: 'numeric' })}</span>
                              </div>
                          </div>
                          <img src={getFullImageUrl(news.imageUrl)} alt={news.name} class="img-fluid rounded-3">
                          <div set:html={news.longText} />
                      </div>
                  </div>
              </div>
          </div>
      </section>
    </main>
  ) : (
    <!-- SI LA NOTICIA NO SE ENCUENTRA, MOSTRAMOS UN MENSAJE AMIGABLE -->
    <main>
      <section class="section">
        <div class="r-container text-center">
          <h2 class="font-1 fw-bold">Noticia no encontrada</h2>
          <p class="my-4">La noticia que estás buscando no se pudo encontrar. Es posible que haya sido eliminada o que la URL sea incorrecta.</p>
          <a href="/blog" class="btn link font-1 fw-bold">Volver al Blog</a>
        </div>
      </section>
    </main>
  )}
</Layout>

<style>
.bg-cover {
  background-size: cover;
  background-position: center;
  min-height: 300px;
}

.section {
  padding: 4rem 0;
}

.accent-color {
  color: var(--accent-color);
}

.bg-secondary-color {
  background-color: var(--secondary-color);
}

.link-white {
  color: white;
  text-decoration: none;
}

.social-container {
  display: flex;
  gap: 1rem;
}
</style>
